name=SL Works With All Hubs Connectivity Manager

category=Works With All Hubs

# This plugin is part of the Works With All Hubs release
released=wwah

qualityString=Alpha Release

quality=development

description=Silicon Labs' implementation of the Works With All Hubs connectivity functions per the Zigbee WWAH Requirements document. This plugin should be included by routers and end devices only. This plugin manages connectivity states to both the hub and, for end devices, to the parent. In the event of connection loss, restoration is performed per the WWAH Connectivity Recovery Procedure as defined in the Zigbee WWAH Requirements specification. The plugin utilizes the Trust Center Keepalive plugin on routers and non-sleepy end devices for determining hub connectivity, while on sleepy end devices, it uses the Poll Control Server plugin for determining hub connectivity. On end devices, this plugin also utilizes the End Device Support plugin for determining parent connectivity.

sourceFiles=wwah-connectivity-manager.c, wwah-connectivity-manager-cli.c

implementedCallbacks=emberAfPluginWwahConnectivityManagerStackStatusCallback,emberAfPluginTrustCenterKeepaliveTimeoutCallback,emberAfPluginPollControlServerCheckInTimeoutCallback,emberAfPluginEndDeviceSupportLostParentConnectivityCallback,emberAfPluginEndDeviceSupportPreNetworkMoveCallback,emberAfPluginTrustCenterKeepaliveConnectivityEstablishedCallback,emberAfPluginTrustCenterKeepaliveServerlessIsSupportedCallback,emberAfTrustCenterKeepaliveOverwriteDefaultTimingCallback,emberAfTrustCenterKeepaliveServerlessIsEnabledCallback

# This plugin should only be included for WWAH routers and end devices only
# WWAH coordinators do not perform network rejoins
includedByDefault=false
trigger.enable_plugin=ZIGBEE_DEVICE_TYPE:!COORDINATOR
trigger.disable_plugin=ZIGBEE_DEVICE_TYPE:COORDINATOR

dependsOnClusterServer=sl works with all hubs

# A router will include trust-center-keepalive while an end device will include
# the poll-control-server plugin in WWAH, which will satisfy this dependency
requiredApis=tc-connectivity

events=stateTransition,longUptime,fastRejoin,badParentRecovery,stateMachine

options=usePreferredChannelMask,preferredChannelMask,fastRejoinTimeoutSec,durationBetweenEachRejoinSec,fastRejoinFirstBackoffTimeSec,maxBackoffTimeSec,maxBackoffIterations,nonFastRejoinBackoffMin,nonFastRejoinBackoffJitterSec,longUptimeThreshold,allowTriggerStateSendRejoin

usePreferredChannelMask.name=Use Preferred Channel Mask When Rejoining
usePreferredChannelMask.description=Use preferred channel mask when attemping to rejoin the network in the event of connection failure. Connection failure includes loss of communication to either the hub or parent (the latter of which only applies to end devices)
usePreferredChannelMask.type=BOOLEAN
usePreferredChannelMask.default=TRUE

preferredChannelMask.name=Preferred Channel Mask For Rejoining
preferredChannelMask.description=The preferred channel mask to scan when attemping to rejoin the network in the event of connection failure
preferredChannelMask.type=CHANNELS
preferredChannelMask.default=0x02308800
preferredChannelMask.dependsOn=usePreferredChannelMask
# For default value, see Base Device specification (13-0402) section 6.2.10.

fastRejoinTimeoutSec.name=Fast Rejoin Timeout Seconds
fastRejoinTimeoutSec.description=The number of seconds that the device should be in fast rejoin mode when the devices loses parent connectivity.
fastRejoinTimeoutSec.type=NUMBER:1,65535
fastRejoinTimeoutSec.default=35

durationBetweenEachRejoinSec.name=Duration Between Each Rejoin Seconds
durationBetweenEachRejoinSec.description=The number of seconds that the device delays between each state when in fast rejoin mode.
durationBetweenEachRejoinSec.type=NUMBER:1,65535
durationBetweenEachRejoinSec.default=7

fastRejoinFirstBackoffTimeSec.name=Fast Rejoin First Backoff Seconds
fastRejoinFirstBackoffTimeSec.description=The number of seconds that the device delays after having completed its first fast rejoin cycle. For subsequent fast rejoin attempt completions, the delay is this value doubled each time (up to a maximum of Max Backoff Time Seconds).
fastRejoinFirstBackoffTimeSec.type=NUMBER:1,65535
fastRejoinFirstBackoffTimeSec.default=30

maxBackoffTimeSec.name=Max Backoff Time Seconds
maxBackoffTimeSec.description=The maximum number of seconds that the device delays after having completed a fast rejoin mode.
maxBackoffTimeSec.type=NUMBER:1,65535
maxBackoffTimeSec.default=90

maxBackoffIterations.name=Max Backoff Iterations
maxBackoffIterations.description=The number of iterations of the Fast Rejoin Backoff the device must perform before it resets its backoff duration to the Fast Rejoin First Backoff Time In Seconds.
maxBackoffIterations.type=NUMBER:1,65535
maxBackoffIterations.default=15

nonFastRejoinBackoffMin.name=Non Fast Rejoin Backoff Minutes
nonFastRejoinBackoffMin.description=The amount of base time, in minutes, that the rejoin algorithm state machine will delay before continuing its attempts to restore hub or parent connectivity. This delay is applicable for all state transitions when not in fast rejoin mode (e.g. routers and end devices that lose hub connectivity only). This delay is also applicable to sleepy end devices when the rejoin state is one of the rejoin algorithm's delay states. Please refer to the Zigbee WWAH Requirements document for information regarding delays. The total delay will be equal to the base time plus the jitter value.
nonFastRejoinBackoffMin.type=NUMBER:1,300
nonFastRejoinBackoffMin.default=1

nonFastRejoinBackoffJitterSec.name=Non Fast Rejoin Backoff Jitter Seconds
nonFastRejoinBackoffJitterSec.description=The amount of jitter time, in seconds, that the rejoin algorithm state machine will delay before continuing its attempts to restore hub or parent connectivity. This delay is applicable for all state transitions when not in fast rejoin mode (e.g. routers and end devices that lose hub connectivity only). This delay is also applicable to sleepy end devices when the rejoin state is one of the rejoin algorithm's delay states. Please refer to the Zigbee WWAH Requirements document for information regarding delays. The total delay will be equal to the base time plus the jitter value.
nonFastRejoinBackoffJitterSec.type=NUMBER:0,300
nonFastRejoinBackoffJitterSec.default=60

longUptimeThreshold.name=Long Uptime Threshold
longUpimeThreshold.description=The amount of time in minutes that pass before this device is considered to have been up for a long time.
longUptimeThreshold.type=NUMBER:0,2147483647
longUptimeThreshold.default=1440

allowTriggerStateSendRejoin.name=Allow to send rejoin attempts in the trigger waiting states
allowTriggerStateSendRejoin.description=Send rejoin attempts when the state is in STATE_WAIT_FOR_TRIGGER or STATE_WAIT_FOR_SECOND_TRIGGER, which aims to accommodate the discrepancy between the "17-01066-029-Zigbee_WWAH_Requirements.docx" and "WWAH Test Cases - 191002.docx". We should remove this plugin option if the discrepancy no longer exists.
allowTriggerStateSendRejoin.type=BOOLEAN
allowTriggerStateSendRejoin.default=FALSE

setup(token) {
  files=wwah-connectivity-manager-tokens.h
}
