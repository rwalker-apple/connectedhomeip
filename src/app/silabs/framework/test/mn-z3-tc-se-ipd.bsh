import com.ember.peek.SimulatedNetwork;

source("util.bsh");

if (runArgument.runUsingMultihop ) {
  std.print("****TODO: Fix for multi-hop and host****");
  return;
}

SimulatedNetwork network = createNetwork();
String[] devices = {"ed0", "mn1", "coord2"};
String[] socImages;
String ncpImage;
if (shouldSkipEccTest()) {
  socImages = new String[] {
    "build/af-test-apps/Z3Switch-simulation/Z3Switch",
    "build/af-test-apps/MnZ3TcSeIpd-simulation/MnZ3TcSeIpd",
    "build/af-test-apps/SeEsp-simulation/SeEsp",
  };
  ncpImage = "app/ncp/sample-app/mn-ncp-spi/simulation/build/exe/mn-ncp-spi";
} else {
  socImages = new String[] {
    "build/af-test-apps/Z3Switch-simulation-REAL_ECC/Z3Switch",
    "build/af-test-apps/MnZ3TcSeIpd-simulation-REAL_ECC/MnZ3TcSeIpd",
    "build/af-test-apps/SeEsp-simulation-REAL_ECC/SeEsp",
  };
  ncpImage = "app/ncp/sample-app/mn-ncp-spi-real_ecc/simulation/build/exe/mn-ncp-spi";
}
String[] hostImages = new String[] {
  "build/af-test-apps/Z3Switch-simulation-ezsp/Z3Switch",
  "build/af-test-apps/MnZ3TcSeIpd-simulation-ezsp/MnZ3TcSeIpd",
  "build/af-test-apps/SeEsp-simulation-ezsp/SeEsp",
};

// Create network and load devices according to the runArguments provided.
addAndLoadDevices(devices, socImages, hostImages, ncpImage);
setupEncryption();

// Debug print is compiled in but disabled by default in the multi-network
// application.
debugprintOn("mn1", "Debug");

// Check that the end device and coordinator have one network and that the
// multi-network node has two.
send("ed0", "info");
expect("ed0",
       ("Nwk cnt: 1.*"
        + "nwk 0 \\[Primary \\(pro\\)\\].*"
        + "  nodeType \\[0x03\\]"),
       timeout,
       true);
send("mn1", "info");
expect("mn1",
       ("Nwk cnt: 2.*"
        + "nwk 0 \\[Coordinator \\(pro\\)\\].*"
        + "  nodeType \\[0x01\\].*"
        + "nwk 1 \\[SleepyEndDevice \\(pro\\)\\].*"
        + "  nodeType \\[0x04\\]"),
       timeout,
       true);
send("coord2", "info");
expect("coord2",
       ("Nwk cnt: 1.*"
        + "nwk 0 \\[Primary \\(pro\\)\\].*"
        + "  nodeType \\[0x01\\]"),
       timeout,
       true);

// Set up the coordinator-side of the multi-network device which comprises of a Z3+SE configuration.
send("mn1", "network set 0");
// The z3 coordinator of mn1 forms a centralized network.
expect("mn1",
       "plugin network-creator start 1",
       "NWK Creator: Form. Channel.*Status: 0x00",
       DEFAULT_TIMEOUT << 1);
// Starting a network between gateway and end device
expect("mn1",
       "plugin network-creator-security open-network",
       ".*Open network: 0x00");
send("ed0",
       "plugin update-tc-link-key timer 5000");
expect("ed0", "plugin network-steering start 1", ".*EMBER_NETWORK_UP.*", DEFAULT_TIMEOUT << 5);
networkWait(5000);
String ed0NodeId = nodeId("ed0");

// Reboot does not work in simulation on the host because the NCP does not
// actually reset.
if (!runArgument.runUsingHostApps) {
  reboot("ed0");
  networkWait(30000);
  setupEncryption();
  networkWait(1000);
}

assert(nodeId("mn1").equals("0x0000"));
String ed0 = findNodeByName("ed0").nodeIdHex;

// Making sure that the new parent that is found is the mn1 trust center.
send("ed0", "zcl global read 0x0000 0x0000");
send("ed0", "send 0x0000 1 1");
expect("mn1", ".*[T00000083:RX len .*, ep .*, clus .* payload[.*]]", 1000);
networkWait(5000);

// Set up the end device-side of the multi-network device with an SE coordinator.
expect("coord2", "network form 20 0 0xBBBB", ".*EMBER_NETWORK_UP.*");
findNodeByName("coord2").nodeIdHex = "0000";

expect("coord2", ".*Registration complete");
expect("coord2", "network pjoin 0xFF", "pJoin for 255 sec: 0x00");
send("mn1", "network set 1");
send("mn1", "network find joinable");
String mn1 = expect("coord2", ".*New node joined, shortID=0x[0-9a-fA-F]{4}", 20000);
mn1 = mn1.substring(mn1.indexOf("shortID=") + 8);
assert(!mn1.equals("0x0000"));
// Depending on how the test is configured to run, this message sometimes comes
// before the one we just waited for on coord2, so just don't bother with this
// one.  If the node doesn't come up, the "Registration complete" will never
// happen and we'll die there.
//expect("mn1", ".*EMBER_NETWORK_UP");
expect("mn1", "Registration complete", 60000);

// Verify that the "info" command returns appropriate information for each
// network on the multi-network device.
String ed0Channel = channel("ed0");
String ed0ExtendedPanId = extendedPanId("ed0");
String ed0PanId = panId("ed0");
send("mn1", "network set 0");
expectMultiline("mn1",
                "info",
                new String[] {
                  "node \\[\\(>\\)" + eui64("mn1") + "\\] chan \\[" + ed0Channel + "\\] pwr \\[3\\]",
                  "panID \\[" + ed0PanId + "\\] nodeID \\[0x0000\\] xpan \\[0x\\(>\\)" + ed0ExtendedPanId + "\\]",
                  "nodeType \\[0x01\\]",
                });
networkWait(1000);
String coord2Channel = channel("coord2");
String coord2ExtendedPanId = extendedPanId("coord2");
String coord2PanId = panId("coord2");
send("mn1", "network set 1");
expectMultiline("mn1",
                "info",
                new String[] {
                  "node \\[\\(>\\)" + eui64("mn1") + "\\] chan \\[" + coord2Channel + "\\] pwr \\[3\\]",
                  "panID \\[" + coord2PanId + "\\] nodeID \\[" + mn1 + "\\] xpan \\[0x\\(>\\)" + coord2ExtendedPanId + "\\]",
                  "nodeType \\[0x04\\]",
                });
networkWait(1000);

// The mn should not have any bindings.
expect("mn1", "option binding-table print", "0 of \\d+ bindings used");
assert(network.expect("mn1", port, null, "[0-9a-fA-F]{2}:.*", timeout, true) == null);

// The Z3 end device should have bindings to from its network
// and first endpoint to the multi-network coordinator.
send("mn1", "network set 0");
expect("mn1", "plugin find-and-bind target 1", ".*Find and Bind Target: Start target: 0x00");
send("ed0", "plugin find-and-bind initiator 1");
networkWait(10000);
checkBindingTable("ed0", 
                  new String[] {
                    ".*: UNICA  0    0x01  0x01  0x0003 0x.... \\(>\\)" + eui64("mn1"),
                    ".*: UNICA  0    0x01  0x01  0x0006 0x.... \\(>\\)" + eui64("mn1"),
                    ".*: UNICA  0    0x01  0x01  0x0008 0x.... \\(>\\)" + eui64("mn1"),
                });
  
// The single-network coordinator should have bindings to the second endpoint
// of the multi-network end device.
checkBindingTable("coord2",
                  new String[] {
                    ".*: UNICA  0    0x01  0x02  0x0700 0x.... \\(>\\)" + eui64("mn1"),
                    ".*: UNICA  0    0x01  0x02  0x0701 0x.... \\(>\\)" + eui64("mn1"),
                    ".*: UNICA  0    0x01  0x02  0x0702 0x.... \\(>\\)" + eui64("mn1"),
                    ".*: UNICA  0    0x01  0x02  0x0703 0x.... \\(>\\)" + eui64("mn1"),
                });


// Set the CLI to the end device network and try sending read attributes on the
// coordinator network.  This should work because the framework will switch the
// network based on the source endpoint.
send("mn1", "network set 1");
send("mn1", "zcl global read 0x0000 0x0000");
send("mn1", "send " + ed0 + " 0x01 0x01");
expect("mn1", "T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expectMultiline("ed0",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]",
                  "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00",
                });
expectMultiline("mn1",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 8, ep 01, clus 0x0000 \\(Basic\\) FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[00 00 00 20 03 \\]",
                  "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00",
                });
expect("ed0", "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 0B payload\\[01 00 \\]");
networkWait(1000);
send("ed0", "zcl global read 0x0000 0x0000");
send("ed0", "send 0x0000 0x01 0x01");
expect("ed0", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expect("mn1", ".*T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]");
expect("mn1", ".*T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00");
expectMultiline("ed0", 
                new String[] {
                "T[0-9a-fA-F]{8}:RX len 8, ep 01, clus 0x0000 \\(Basic\\) FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[00 00 00 20 03 \\]",
                "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00",
});
expect("mn1", ".*T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 0B payload\\[01 00 \\]");
networkWait(1000);

// Set the CLI to the coordinator network and try sending read attributes on
// the end device network.  Again, this should work.
send("mn1", "network set 0");
send("mn1", "zcl global read 0x0000 0x0000");
send("mn1", "send 0x0000 0x02 0x01");
expect("mn1", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expect("coord2", "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]");
// in order to avoid an ordering problem on Host, removed the multiline expect statement
//expect("coord2", "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00");
// expectMultiline("mn1",
//                 new String[] {
//                   "T[0-9a-fA-F]{8}:RX len 8, ep 02, clus 0x0000 \\(Basic\\) FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[00 00 00 20 03 \\]",
//                   "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00",
//                 });
expect("mn1", "", "T[0-9a-fA-F]{8}:RX len 8, ep 02, clus 0x0000 \\(Basic\\) FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[00 00 00 20 03 \\]");
expect("coord2", "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 0B payload\\[01 00 \\]");
//expect("mn1", "", "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00");
networkWait(1000);

// These are similar read attributes commands, except they use APS encryption
// because they are for the Time cluster.
send("ed0", "zcl global read 0x000A 0x0000");
send("ed0", "send 0x0000 0x01 0x01");
expect("ed0", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expect("mn1",
       "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x000A \\(Time\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]");
expect("mn1",
       "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00");
expectMultiline("ed0",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 6, ep 01, clus 0x000A .* FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[([0-9a-fA-F]{2} ){3}\\]",
                  "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00",
                },
                5000);
expect("mn1", "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x000A \\(Time\\) FC 00 seq [0-9a-fA-F]{2} cmd 0B payload\\[01 00 \\]");
networkWait(1000);
send("mn1", "zcl global read 0x000A 0x0000");
send("mn1", "send 0x0000 0x02 0x01");
expect("mn1", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00 w/ link key");
expect("coord2", "T[0-9a-fA-F]{8}:RX len 5, ep 01, clus 0x000A \\(Time\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]");
//expect("coord2", "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00 w/ link key");
expectMultiline("mn1",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 11, ep 02, clus 0x000A \\(Time\\) FC 08 seq [0-9a-fA-F]{2} cmd 01 payload\\[([0-9a-fA-F]{2} ){8}\\]",
                  "T[0-9a-fA-F]{8}:TX \\(resp\\) Ucast 0x00 w/ link key",
                });
networkWait(1000);

// Another read attributes command, but this time to the wrong endpoint.  The
// single-network end device will send to the end device side of dual network
// device.  The message should be dropped.
send("ed0", "zcl global read 0x0000 0x0000");
send("ed0", "send 0x0000 0x01 0x02");
expect("ed0", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expectMultiline("mn1",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 5, ep 02, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]",
                  "Drop cluster 0x0000 command 0x00 for endpoint 0x02 due to wrong network: 0",
                });
assert(network.expect("mn1", port, "T[0-9a-fA-F]{8}:TX.*", 1000, true) == null);
assert(network.expect("ed0", port, "T[0-9a-fA-F]{8}:RX.*", 1000, true) == null);
networkWait(1000);

// Similiar, except the read attributes message is sent to the broadcast
// endpoint and should be dropped on mismatched networks.
send("ed0", "zcl global read 0x0000 0x0000");
send("ed0", "send 0x0000 0x01 0xFF");
expect("ed0", ".*T[0-9a-fA-F]{8}:TX \\(CLI\\) Ucast 0x00");
expectMultiline("mn1",
                new String[] {
                  "T[0-9a-fA-F]{8}:RX len 5, ep FF, clus 0x0000 \\(Basic\\) FC 00 seq [0-9a-fA-F]{2} cmd 00 payload\\[00 00 \\]",
                  "Drop cluster 0x0000 command 0x00 for endpoint 0x02 due to wrong network: 0",
                });
networkWait(1000);

// Verify that service discovery works and that discovery can take place on
// each network at the same time.
send("mn1", "network set 0");
send("mn1", "option disc 0x0109 0x0000");
send("mn1"," network set 1");
send("mn1", "option disc 0x0109 0x0000");

expectMultiline("mn1",
                new String[] {
                  ".*Service discovery done.*",
                  ".*Service discovery done.*",
                });

networkWait(5000);
send("mn1", "network set 0");
send("mn1", "zdo ieee " + ed0);
send("mn1"," network set 1");
send("mn1", "zdo ieee 0x0000");
expectMultiline("mn1",
                new String[] {
                  "IEEE Address response: \\(>\\)(" + eui64("ed0") + "|" + eui64("coord2") + ")",
                  "IEEE Address response: \\(>\\)(" + eui64("ed0") + "|" + eui64("coord2") + ")",
                });
networkWait(5000);
send("mn1", "network set 0");
expect("mn1", "zdo nwk {" + eui64("ed0") + "}",
       "NWK Address response: " + ed0);
send("mn1"," network set 1");
expect("mn1", "zdo nwk {" + eui64("coord2") + "}",
       "NWK Address response: 0x0000", 
       2000);
networkWait(5000);

//Testing Distributed Network of the multi network node Zigbee 3.0
send("mn1", "network set 0");
expect("mn1", "network leave", ".*EMBER_NETWORK_DOWN.*");
expect("ed0", "network leave", ".*EMBER_NETWORK_DOWN.*");
networkWait(5000);

expect("mn1",
       "plugin network-creator start 0",
       "NWK Creator: Form. Channel.*Status: 0x00",
       DEFAULT_TIMEOUT << 1);
// Starting a network between TC and end device
expect("mn1",
       "plugin network-creator-security open-network",
       ".*Open network: 0x00");
expect("ed0", "plugin network-steering start 1", ".*EMBER_NETWORK_UP.*", DEFAULT_TIMEOUT << 5);
networkWait(10000);
// Making sure that the new parent that is found is the mn trust center.
send("ed0", "zcl global read 0x0000 0x0000");
send("ed0", "send " + nodeId("mn1") + " 1 1");
expect("mn1", ".*[RX len 8, ep 01, clus 0x0000 (Basic) FC 08 seq [0-9A-F]{2} cmd 01 payload[00 00 00 20 03 ]]");